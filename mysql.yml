---
- hosts: all
  become: yes
  become_method: sudo
  become_user: root
  vars:
    dbaas_version: "{{ morpheus['customOptions']['dbaasVersion'] }}"
    dbaas_username: "{{ morpheus['customOptions']['dbaasUsername'] }}"
    dbaas_password: "{{ morpheus['customOptions']['dbaasPassword'] }}"
    db_name: "{{ morpheus['customOptions']['dbName'] }}"
 
  tasks:
   - name: Install required packages
     apt:
       name:
         - sudo
         - acl
         - python3-pip
         - python3-mysqldb
       state: present
       update_cache: yes

   - name: Add MySQL APT repository
     apt_repository:
       repo: 'deb http://repo.mysql.com/apt/ubuntu/ {{ ansible_distribution_release }} mysql-{{ dbaas_version }}'
       state: present
       filename: mysql

   - name: Add MySQL APT key
     apt_key:
       url: https://repo.mysql.com/RPM-GPG-KEY-mysql
       state: present

   - name: Install MySQL Server with specific version
     apt:
       pkg:
         - mysql-server={{ dbaas_version }}*
         - mysql-client={{ dbaas_version }}*
       state: present
       update_cache: yes

   - name: Ensure MySQL is running
     systemd:
       name: mysql
       state: started
       enabled: yes

   - name: Create application database
     mysql_db:
       name: "{{ db_name }}"
       state: present
       login_unix_socket: /var/run/mysqld/mysqld.sock

   - name: Create database user
     mysql_user:
       name: "{{ dbaas_username }}"
       password: "{{ dbaas_password }}"
       priv: "{{ db_name }}.*:ALL"
       host: '%'
       state: present
       login_unix_socket: /var/run/mysqld/mysqld.sock

   - name: Allow remote connections
     replace:
       path: /etc/mysql/mysql.conf.d/mysqld.cnf
       regexp: '^bind-address\s*=\s*127\.0\.0\.1'
       replace: 'bind-address = 0.0.0.0'
     notify: Restart MySQL

  handlers:
   - name: Restart MySQL
     systemd:
       name: mysql
       state: restarted
